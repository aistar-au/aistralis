name: autofix

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install stable Rust (with rustfmt)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Install Taplo (TOML formatter)
        uses: uncenter/setup-taplo@v1
        with:
          version: "0.8.1"

      # Normalize repo line endings so GitHub raw endpoints show proper multi-line files
      - name: Normalize line endings (LF)
        run: |
          set -euo pipefail
          git add --renormalize .
          echo "After renormalize:"
          git status --porcelain || true

      - name: Rustfmt (apply)
        run: cargo fmt

      - name: Taplo fmt (apply)
        run: taplo fmt

      # Optional: leave off until formatting is settled
      - name: Cargo fix (apply)
        run: cargo fix --allow-dirty --allow-staged || true

      - name: Debug diffs
        run: |
          set -euo pipefail
          echo "Cargo.toml line count:"
          wc -l Cargo.toml || true
          echo ""
          echo "Git status:"
          git status --porcelain || true
          echo ""
          echo "Git diff (stat):"
          git diff --stat || true

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: autofix formatting"
          title: "chore: autofix formatting"
          body: |
            Automated formatting fixes:
            - git add --renormalize .
            - cargo fmt
            - taplo fmt
            - cargo fix (best-effort)

            Notes:
            - If no PR is created, check the "Debug diffs" step output for an empty diff.
          branch: autofix/formatting
          delete-branch: true