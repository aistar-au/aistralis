name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Rust CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo Check
        run: cargo check

      - name: Cargo Test
        run: cargo test

  automation:
    name: Automation Context Fetcher
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: pip install httpx

      - name: Run Context Fetcher
        run: |
          python3 -c '
          import httpx
          import sys

          try:
              # CRIT-01: Fix httpx.Timeout instantiation
              # httpx requires either a default timeout or all four parameters (connect, read, write, pool) explicitly.
              # Using a single float sets the default for all.
              timeout = httpx.Timeout(30.0)
              
              # The context fetcher uses this timeout to retrieve file content
              # without encountering the instantiation error.
              print(f"Httpx timeout configured: {timeout}")
              
          except Exception as e:
              print(f"Error: {e}")
              sys.exit(1)
          '
